ARG IMAGE_VER=lunar-20230731

FROM ubuntu:${IMAGE_VER}

ARG VERSION=2023.1.1

LABEL maintainer="DHN Chandan <biogrids.io@gmail.com>"
LABEL version=${VERSION}
LABEL github="https://github.com/bio-grids/molecular_dynamics_utils"

SHELL [ "/bin/bash", "--login", "-c" ]

# Update os
RUN apt-get update -y

# Install build dependencies
ARG build_deps="\
    ca-certificates \
    libxml2 \
    wget"
RUN apt-get install --yes --no-install-recommends --quiet $build_deps

WORKDIR /tmp
RUN wget https://developer.download.nvidia.com/compute/cuda/repos/ubuntu2204/x86_64/cuda-ubuntu2204.pin
RUN mv cuda-ubuntu2204.pin /etc/apt/preferences.d/cuda-repository-pin-600
RUN wget https://developer.download.nvidia.com/compute/cuda/12.2.2/local_installers/cuda-repo-ubuntu2204-12-2-local_12.2.2-535.104.05-1_amd64.deb
RUN dpkg -i cuda-repo-ubuntu2204-12-2-local_12.2.2-535.104.05-1_amd64.deb
RUN cp /var/cuda-repo-ubuntu2204-12-2-local/cuda-*-keyring.gpg /usr/share/keyrings/
RUN apt-get update
RUN apt-get -y install cuda

# Install app dependencies
ARG app_deps="libboost-all-dev"
RUN apt-get install --yes --no-install-recommends --quiet $app_deps

# ENV PATH=$PATH:/adgpu/

# clean os
RUN rm -rf /tmp/*
RUN rm -rf /var/lib/apt/lists/*
RUN apt-get remove -y $build_deps
# RUN apt-get autoremove -y
RUN apt-get clean -y

# make data work directory
RUN cd / && mkdir -p data
WORKDIR /data
